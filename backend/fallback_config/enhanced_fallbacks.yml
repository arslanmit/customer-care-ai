# =========================================================
# Enhanced Fallback Configuration
# =========================================================
# This configuration:
# 1. Implements a two-stage fallback strategy
# 2. Adds rule-based fallbacks for common scenarios
# 3. Improves the overall robustness of the chatbot
# =========================================================

version: "3.1"

# Fallback policies to add to config.yml
policies:
  - name: RulePolicy
  - name: MemoizationPolicy
    max_history: 5
    epochs: 100
  - name: TEDPolicy
    max_history: 5
    epochs: 100
    constrain_similarities: true
  - name: FallbackClassifier
    threshold: 0.7
    ambiguity_threshold: 0.2

# Rules to add to rules.yml
rules:
  - rule: Fallback when low confidence
    steps:
      - intent: nlu_fallback
      - action: action_fallback_handler

  - rule: Ask the user to rephrase when they send a message with low NLU confidence
    steps:
      - intent: nlu_fallback
      - action: utter_please_rephrase

  - rule: Two-stage-fallback
    steps:
      - intent: nlu_fallback
      - action: action_two_stage_fallback
      - active_loop: two_stage_fallback_form

# Actions to add to domain.yml
actions:
  - action_fallback_handler
  - action_two_stage_fallback
  - validate_two_stage_fallback_form

# Forms to add to domain.yml
forms:
  two_stage_fallback_form:
    required_slots: []

# Responses to add to domain.yml
responses:
  utter_please_rephrase:
    - text: I didn't quite understand that. Could you rephrase your question?
    - text: I'm not sure I follow. Could you try asking that in a different way?
    - text: I'm having trouble understanding. Can you rephrase that?
  
  utter_default:
    - text: I'm afraid I can't help with that specific request. Let me connect you with our customer support team.
    - text: I'm not sure how to help with that. Would you like me to provide information about our services instead?
    - text: I don't have an answer for that. Is there something else I can help with?

  utter_suggestion:
    - text: "Sorry I didn't understand that. Did you mean one of these:\n{suggestions}"
    - text: "I'm not sure what you mean. Did you want to:\n{suggestions}"
    - text: "I didn't catch that. Were you trying to:\n{suggestions}"
